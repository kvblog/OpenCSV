
@if (isAuthenticated()) {
  <div class="h-screen flex flex-col bg-surface overflow-hidden relative font-sans">
    
    <!-- Material 3 Top App Bar with Safe Area Padding -->
    <!-- Added pt-[calc(env(safe-area-inset-top)+0.5rem)] to handle status bar notch -->
    <header class="flex-none bg-surface-light px-4 pt-[calc(env(safe-area-inset-top)+0.5rem)] pb-2 flex items-center justify-between z-30 relative shadow-sm transition-shadow">
      
      <!-- Left: Logo & Title -->
      <div class="flex items-center gap-4">
        <!-- Increased Logo Size -->
        <div class="relative w-14 h-14 rounded-full overflow-hidden cursor-pointer hover:opacity-80 transition-opacity" (click)="currentView() !== 'upload' ? setView('viewer') : null">
          <img 
            src="https://i.pinimg.com/736x/0b/1e/cf/0b1ecf40813d4156ea1488d7d5bff829.jpg" 
            alt="App Icon" 
            class="w-full h-full object-cover"
          />
        </div>
        <div class="flex flex-col">
          <h1 class="font-normal text-[#1F1F1F] text-xl leading-none">ШР ДШБ</h1>
          @if (fileName()) {
             <div class="flex items-center gap-2 mt-0.5">
                <span class="text-xs text-[#444746] max-w-[150px] truncate">{{ fileName() }}</span>
                @if (currentView() === 'viewer' && rowCount() !== allRows().length) {
                  <span class="text-[10px] bg-primary-container text-primary-onContainer px-2 py-0.5 rounded-full font-medium">
                    {{ rowCount() }}
                  </span>
                }
             </div>
          }
        </div>
      </div>

      <!-- Center/Right: Actions (Desktop) -->
      <div class="hidden md:flex items-center gap-2">
        @if (currentView() !== 'upload') {
          
          <!-- Expandable Search Bar -->
          <div 
             class="relative flex items-center bg-transparent transition-all duration-300 ease-in-out h-10 overflow-hidden mr-2"
             [class.w-10]="!isSearchExpanded()"
             [class.w-80]="isSearchExpanded()"
             [class.bg-[#E3E3E3]]="isSearchExpanded()"
             [class.rounded-full]="true"
             [class.shadow-sm]="isSearchExpanded()"
          >
             <button 
               (click)="toggleSearch()" 
               class="absolute left-0 top-0 w-10 h-10 flex items-center justify-center rounded-full text-[#444746] hover:bg-[#E3E3E3] hover:text-[#1F1F1F] z-10"
               [class.bg-transparent]="isSearchExpanded()"
               title="Поиск"
             >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
             </button>

             <input 
               #searchInput
               type="text" 
               [(ngModel)]="searchQuery" 
               placeholder="Поиск..." 
               class="w-full h-full bg-transparent border-none focus:ring-0 text-sm text-[#1F1F1F] placeholder-[#444746] pl-10 pr-10 outline-none"
               [tabindex]="isSearchExpanded() ? 0 : -1"
             >

             @if (isSearchExpanded()) {
               <button 
                 (click)="closeSearch()" 
                 class="absolute right-0 top-0 w-10 h-10 flex items-center justify-center text-[#444746] hover:text-[#B3261E] z-10"
               >
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
               </button>
             }
          </div>

          <!-- Navigation Segmented Button -->
          <div class="flex items-center bg-[#E0E2EC] rounded-full p-1 h-10 mr-2">
             <button 
               (click)="setView('viewer')"
               class="px-5 h-full rounded-full text-sm font-medium transition-all flex items-center gap-2"
               [class.bg-white]="currentView() === 'viewer'"
               [class.shadow-sm]="currentView() === 'viewer'"
               [class.text-[#1F1F1F]]="currentView() === 'viewer'"
               [class.text-[#444746]]="currentView() !== 'viewer'"
             >
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
               Таблица
             </button>
             <button 
               (click)="setView('dashboard')"
               class="px-5 h-full rounded-full text-sm font-medium transition-all flex items-center gap-2"
               [class.bg-white]="currentView() === 'dashboard'"
               [class.shadow-sm]="currentView() === 'dashboard'"
               [class.text-[#1F1F1F]]="currentView() === 'dashboard'"
               [class.text-[#444746]]="currentView() !== 'dashboard'"
             >
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
               Карточки
             </button>
          </div>

          @if (currentView() === 'viewer') {
            <!-- Font Size -->
            <div class="flex items-center gap-1 mr-2 bg-[#E0E2EC] rounded-full px-2 h-10">
              <button (click)="changeFontSize(-1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/50 text-[#444746]">-</button>
              <span class="text-xs font-medium w-6 text-center text-[#1F1F1F]">{{ tableFontSize() }}</span>
              <button (click)="changeFontSize(1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/50 text-[#444746]">+</button>
            </div>

            <!-- Filter Chip -->
            <button (click)="openFilterModal()" class="h-10 px-4 rounded-full border border-outline-variant hover:bg-[#F2F2F2] flex items-center gap-2 text-sm font-medium text-[#1F1F1F] transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
              Фильтр
            </button>
          }

          <!-- New File FAB-like button (Reset) -->
          <button (click)="reset()" class="h-10 w-10 rounded-full bg-primary-container text-primary-onContainer flex items-center justify-center hover:shadow-md transition-shadow" title="Новый файл">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          </button>
        }
      </div>

      <!-- Mobile Menu Button -->
      <div class="md:hidden">
        <button (click)="toggleMobileMenu()" class="p-2 text-[#444746] rounded-full hover:bg-[#F2F2F2]">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            @if (!isMobileMenuOpen()) {
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            } @else {
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            }
          </svg>
        </button>
      </div>

      <!-- Mobile Dropdown -->
      @if (isMobileMenuOpen()) {
        <div class="absolute top-full left-0 right-0 bg-white border-t border-[#E3E3E3] shadow-lg p-4 flex flex-col gap-3 md:hidden animate-[slideDown_0.2s_ease-out] z-40 rounded-b-xl">
          @if (currentView() !== 'upload') {
             <div class="bg-[#F2F2F2] rounded-full flex items-center px-4 py-2">
                <svg class="w-5 h-5 text-[#444746]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" [(ngModel)]="searchQuery" placeholder="Поиск..." class="bg-transparent border-none focus:ring-0 w-full ml-2 text-sm">
             </div>

             <div class="grid grid-cols-2 gap-2">
               <button (click)="setView('viewer')" class="p-3 rounded-xl bg-primary-container text-primary-onContainer text-sm font-medium text-center">Таблица</button>
               <button (click)="setView('dashboard')" class="p-3 rounded-xl bg-[#E3E3E3] text-[#1F1F1F] text-sm font-medium text-center">Карточки</button>
             </div>
             
             <button (click)="openFilterModal()" class="w-full p-3 rounded-xl bg-[#E0E2EC] text-[#1F1F1F] text-sm font-medium flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Фильтр
             </button>

             <button (click)="reset()" class="w-full p-3 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm font-medium">Открыть новый файл (Сброс)</button>
          }
        </div>
      }
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden flex flex-row">
      
      <!-- Loading Overlay -->
      @if (isLoading()) {
        <div class="absolute inset-0 z-50 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center animate-[fadeIn_0.3s]">
          <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
          <p class="text-[#444746] font-medium">Обработка данных...</p>
        </div>
      }

      <!-- Upload State -->
      @if (currentView() === 'upload' && !isLoading()) {
        <div class="flex-1 flex flex-col items-center justify-center p-8 w-full max-w-2xl mx-auto animate-[fadeIn_0.5s]">
          <app-csv-uploader (fileLoaded)="onFileLoaded($event)" (imagesLoaded)="onImagesLoaded($event)" class="w-full"></app-csv-uploader>
        </div>
      }

      <!-- Viewer State -->
      @if (currentView() === 'viewer') {
        <div class="flex-1 overflow-auto custom-scrollbar bg-white shadow-inner select-none md:select-auto px-4 py-2">
           <div class="bg-white rounded-[20px] border border-[#E3E3E3] overflow-hidden shadow-sm max-h-full flex flex-col">
             <!-- Table Container -->
             <div class="overflow-x-auto overflow-y-auto custom-scrollbar flex-1">
                <table class="min-w-full table-auto border-collapse">
                  <thead class="bg-[#F2F2F2] sticky top-0 z-10 shadow-sm">
                    <tr>
                      @for (header of headers(); track header) {
                        <th 
                          class="py-3 px-4 font-medium text-[#444746] text-sm text-left whitespace-nowrap"
                          [style.font-size.px]="tableFontSize()">
                          {{ header }}
                        </th>
                      }
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of filteredRows(); track $index) {
                      <tr 
                        (click)="selectRow($index)"
                        (mousedown)="startLongPress($index, row)"
                        (touchstart)="startLongPress($index, row)"
                        (mouseup)="cancelLongPress()"
                        (touchend)="cancelLongPress()"
                        (mouseleave)="cancelLongPress()"
                        (contextmenu)="$event.preventDefault()"
                        [class]="getRowClasses(row, $index)"
                      >
                        @for (header of headers(); track header) {
                          <td 
                            class="py-3 px-4 whitespace-nowrap text-inherit"
                            [style.font-size.px]="tableFontSize()">
                            {{ row[header] }}
                          </td>
                        }
                      </tr>
                    }
                  </tbody>
                </table>
             </div>
           </div>
          
          @if (filteredRows().length === 0) {
            <div class="flex flex-col items-center justify-center h-64 text-[#444746]">
              <p>Нет данных для отображения</p>
            </div>
          }
        </div>
      }

      <!-- Dashboard State -->
      @if (currentView() === 'dashboard') {
        <div class="flex-1 overflow-hidden relative">
          <app-dashboard 
             [rows]="allRows()" 
             [images]="imageMap()" 
             [searchText]="searchQuery()"
             [filters]="activeFilters()"
             (detailRequested)="openDetailModal($event)"
          ></app-dashboard>
        </div>
      }
    </main>

    <!-- Detail Modal -->
    @if (isDetailModalOpen()) {
      <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
         <div class="bg-surface w-full max-w-lg rounded-[28px] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="px-6 py-4 bg-surface-light border-b border-[#E3E3E3] flex justify-between items-center">
               <h2 class="text-xl font-medium text-[#1F1F1F] truncate pr-4">{{ detailTitle() }}</h2>
               <button (click)="closeDetailModal()" class="text-[#444746] hover:bg-[#E3E3E3] rounded-full p-2">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
               </button>
            </div>
            <div class="overflow-y-auto p-6 custom-scrollbar flex-1 bg-surface">
               @if (detailData(); as row) {
                 <div class="grid grid-cols-1 gap-4">
                   @for (header of headers(); track header) {
                     @if (row[header]) {
                        <div class="flex flex-col border-b border-[#E3E3E3] last:border-0 pb-2 last:pb-0">
                           <span class="text-xs font-medium text-[#444746] uppercase tracking-wide">{{ header }}</span>
                           <span class="text-base text-[#1F1F1F] mt-1 whitespace-pre-wrap">{{ row[header] }}</span>
                        </div>
                     }
                   }
                 </div>
               }
            </div>
            <div class="px-6 py-4 border-t border-[#E3E3E3] bg-surface-light flex justify-end">
               <button (click)="closeDetailModal()" class="px-6 py-2 bg-primary text-white font-medium rounded-full shadow-elevation-1 hover:shadow-elevation-2">Закрыть</button>
            </div>
         </div>
      </div>
    }

    <!-- Filter Modal -->
    @if (isFilterModalOpen()) {
      <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
        <div class="bg-[#FDFDFD] w-full max-w-2xl rounded-[28px] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
          <div class="px-6 py-4 border-b border-[#E3E3E3] flex justify-between items-center">
            <h2 class="text-xl font-normal text-[#1F1F1F]">Фильтр</h2>
            <button (click)="closeFilterModal()" class="text-[#444746] hover:bg-[#F2F2F2] rounded-full p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
          <div class="flex flex-1 overflow-hidden">
            <div class="w-1/3 border-r border-[#E3E3E3] bg-[#F3F6FC] overflow-y-auto custom-scrollbar py-2">
              @for (col of availableFilterColumns(); track col) {
                <button 
                  (click)="selectFilterColumnInModal(col)"
                  class="w-full text-left px-4 py-3 text-sm font-medium flex items-center justify-between"
                  [class.bg-[#D3E3FD]]="selectedFilterColumn() === col"
                  [class.text-[#041E49]]="selectedFilterColumn() === col"
                  [class.text-[#444746]]="selectedFilterColumn() !== col"
                >
                  {{ col }}
                  @if (tempFilters()[col]?.size) {
                    <div class="w-2 h-2 rounded-full bg-primary"></div>
                  }
                </button>
              }
            </div>
            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
              @if (selectedFilterColumn()) {
                 <div class="flex flex-col gap-2">
                  @for (val of filterColumnValues(); track val) {
                    <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-[#F2F2F2] cursor-pointer">
                      <input 
                        type="checkbox" 
                        [checked]="isFilterValueSelected(selectedFilterColumn()!, val)"
                        (change)="toggleFilterValue(val)"
                        class="w-5 h-5 rounded border-[#747775] text-primary focus:ring-primary"
                      />
                      <span class="text-sm text-[#1F1F1F]">{{ val }}</span>
                    </label>
                  }
                 </div>
              }
            </div>
          </div>
          <div class="px-6 py-4 border-t border-[#E3E3E3] flex justify-end gap-2">
             <button (click)="clearAllFilters()" class="px-4 py-2 text-primary font-medium text-sm hover:bg-primary-container/30 rounded-full">Сбросить</button>
             <button (click)="applyFilters()" class="px-6 py-2 bg-primary text-white font-medium text-sm rounded-full shadow-elevation-1 hover:shadow-elevation-2">Применить</button>
          </div>
        </div>
      </div>
    }

  </div>
} @else {
  <!-- PIN SCREEN -->
  <div class="fixed inset-0 bg-[#1F1F1F] z-[100] flex flex-col items-center justify-center p-6 text-white animate-[fadeIn_0.5s_ease-out]">
    <div class="mb-10 text-center">
       <div class="w-24 h-24 mx-auto rounded-full overflow-hidden border-4 border-[#444746] mb-6 shadow-xl">
         <img src="https://i.pinimg.com/736x/0b/1e/cf/0b1ecf40813d4156ea1488d7d5bff829.jpg" alt="App Icon" class="w-full h-full object-cover opacity-90">
       </div>
       <h1 class="text-2xl font-bold tracking-wider mb-2">ШР ДШБ</h1>
       <p class="text-[#C4C7C5] text-sm">{{ getPinTitle() }}</p>
    </div>

    <div class="h-6 mb-6">
      @if (pinError()) {
        <p class="text-[#F2B8B5] text-sm font-medium animate-[shake_0.4s_ease-in-out]">{{ pinError() }}</p>
      }
    </div>

    <div class="flex gap-6 mb-10">
      @for (i of [0,1,2,3]; track i) {
         <div class="w-4 h-4 rounded-full border-2 border-[#8E918F] transition-all duration-200"
              [class.bg-[#E3E3E3]]="enteredPin().length > i"
              [class.border-[#E3E3E3]]="enteredPin().length > i"
              [class.scale-110]="enteredPin().length > i"
              [class.bg-transparent]="enteredPin().length <= i">
         </div>
      }
    </div>

    <div class="grid grid-cols-3 gap-8 w-64">
      @for (num of [1,2,3,4,5,6,7,8,9]; track num) {
         <button 
           (click)="addPinDigit(num)" 
           class="w-16 h-16 rounded-full bg-[#303033] hover:bg-[#444746] text-2xl font-normal flex items-center justify-center transition-all active:scale-95"
         >
           {{ num }}
         </button>
      }
      <div></div>
      <button 
        (click)="addPinDigit(0)" 
        class="w-16 h-16 rounded-full bg-[#303033] hover:bg-[#444746] text-2xl font-normal flex items-center justify-center transition-all active:scale-95"
      >
        0
      </button>
      <button 
        (click)="removePinDigit()" 
        class="w-16 h-16 rounded-full flex items-center justify-center text-[#C4C7C5] hover:text-white transition-colors"
      >
         <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
      </button>
    </div>
  </div>
}

<style>
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
</style>